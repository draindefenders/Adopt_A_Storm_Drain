{"ast":null,"code":"var __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n/**\n * @module ol/renderer/canvas/VectorImageLayer\n */\n\n\nimport ImageCanvas from '../../ImageCanvas.js';\nimport ViewHint from '../../ViewHint.js';\nimport { getHeight, getWidth, isEmpty, scaleFromCenter } from '../../extent.js';\nimport { assign } from '../../obj.js';\nimport CanvasImageLayerRenderer from './ImageLayer.js';\nimport CanvasVectorLayerRenderer from './VectorLayer.js';\nimport EventType from '../../events/EventType.js';\nimport ImageState from '../../ImageState.js';\nimport { renderDeclutterItems } from '../../render.js';\nimport { apply, compose, create } from '../../transform.js';\n/**\n * @classdesc\n * Canvas renderer for image layers.\n * @api\n */\n\nvar CanvasVectorImageLayerRenderer =\n/** @class */\nfunction (_super) {\n  __extends(CanvasVectorImageLayerRenderer, _super);\n  /**\n   * @param {import(\"../../layer/VectorImage.js\").default} layer Vector image layer.\n   */\n\n\n  function CanvasVectorImageLayerRenderer(layer) {\n    var _this = _super.call(this, layer) || this;\n    /**\n     * @private\n     * @type {import(\"./VectorLayer.js\").default}\n     */\n\n\n    _this.vectorRenderer_ = new CanvasVectorLayerRenderer(layer);\n    /**\n     * @private\n     * @type {number}\n     */\n\n    _this.layerImageRatio_ = layer.getImageRatio();\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n\n    _this.coordinateToVectorPixelTransform_ = create();\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n\n    _this.renderedPixelToCoordinateTransform_ = null;\n    return _this;\n  }\n  /**\n   * @inheritDoc\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.disposeInternal = function () {\n    this.vectorRenderer_.dispose();\n\n    _super.prototype.disposeInternal.call(this);\n  };\n  /**\n   * @inheritDoc\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.getFeatures = function (pixel) {\n    if (this.vectorRenderer_) {\n      var vectorPixel = apply(this.coordinateToVectorPixelTransform_, apply(this.renderedPixelToCoordinateTransform_, pixel.slice()));\n      return this.vectorRenderer_.getFeatures(vectorPixel);\n    } else {\n      var promise = new Promise(function (resolve, reject) {\n        resolve([]);\n      });\n      return promise;\n    }\n  };\n  /**\n   * @inheritDoc\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.handleFontsChanged = function () {\n    this.vectorRenderer_.handleFontsChanged();\n  };\n  /**\n   * @inheritDoc\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.prepareFrame = function (frameState) {\n    var pixelRatio = frameState.pixelRatio;\n    var viewState = frameState.viewState;\n    var viewResolution = viewState.resolution;\n    var hints = frameState.viewHints;\n    var vectorRenderer = this.vectorRenderer_;\n    var renderedExtent = frameState.extent;\n\n    if (this.layerImageRatio_ !== 1) {\n      renderedExtent = renderedExtent.slice(0);\n      scaleFromCenter(renderedExtent, this.layerImageRatio_);\n    }\n\n    var width = getWidth(renderedExtent) / viewResolution;\n    var height = getHeight(renderedExtent) / viewResolution;\n\n    if (!hints[ViewHint.ANIMATING] && !hints[ViewHint.INTERACTING] && !isEmpty(renderedExtent)) {\n      vectorRenderer.useContainer(null, null, 1);\n      var context = vectorRenderer.context;\n      var imageFrameState_1 =\n      /** @type {import(\"../../PluggableMap.js\").FrameState} */\n      assign({}, frameState, {\n        declutterItems: [],\n        extent: renderedExtent,\n        size: [width, height],\n        viewState:\n        /** @type {import(\"../../View.js\").State} */\n        assign({}, frameState.viewState, {\n          rotation: 0\n        })\n      });\n      var image_1 = new ImageCanvas(renderedExtent, viewResolution, pixelRatio, context.canvas, function (callback) {\n        if (vectorRenderer.prepareFrame(imageFrameState_1) && vectorRenderer.replayGroupChanged) {\n          vectorRenderer.renderFrame(imageFrameState_1, null);\n          renderDeclutterItems(imageFrameState_1, null);\n          callback();\n        }\n      });\n      image_1.addEventListener(EventType.CHANGE, function () {\n        if (image_1.getState() === ImageState.LOADED) {\n          this.image_ = image_1;\n        }\n      }.bind(this));\n      image_1.load();\n    }\n\n    if (this.image_) {\n      var image = this.image_;\n      var imageResolution = image.getResolution();\n      var imagePixelRatio = image.getPixelRatio();\n      var renderedResolution = imageResolution * pixelRatio / imagePixelRatio;\n      this.renderedResolution = renderedResolution;\n      this.renderedPixelToCoordinateTransform_ = frameState.pixelToCoordinateTransform.slice();\n      this.coordinateToVectorPixelTransform_ = compose(this.coordinateToVectorPixelTransform_, width / 2, height / 2, 1 / renderedResolution, -1 / renderedResolution, 0, -viewState.center[0], -viewState.center[1]);\n    }\n\n    return !!this.image_;\n  };\n  /**\n   * @override\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.preRender = function () {};\n  /**\n   * @override\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.postRender = function () {};\n  /**\n   * @inheritDoc\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.forEachFeatureAtCoordinate = function (coordinate, frameState, hitTolerance, callback, declutteredFeatures) {\n    if (this.vectorRenderer_) {\n      return this.vectorRenderer_.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, declutteredFeatures);\n    } else {\n      return _super.prototype.forEachFeatureAtCoordinate.call(this, coordinate, frameState, hitTolerance, callback, declutteredFeatures);\n    }\n  };\n\n  return CanvasVectorImageLayerRenderer;\n}(CanvasImageLayerRenderer);\n\nexport default CanvasVectorImageLayerRenderer;","map":{"version":3,"sources":["../../src/renderer/canvas/VectorImageLayer.js"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\n/**\n * @module ol/renderer/canvas/VectorImageLayer\n */\nimport ImageCanvas from '../../ImageCanvas.js';\nimport ViewHint from '../../ViewHint.js';\nimport { getHeight, getWidth, isEmpty, scaleFromCenter } from '../../extent.js';\nimport { assign } from '../../obj.js';\nimport CanvasImageLayerRenderer from './ImageLayer.js';\nimport CanvasVectorLayerRenderer from './VectorLayer.js';\nimport EventType from '../../events/EventType.js';\nimport ImageState from '../../ImageState.js';\nimport { renderDeclutterItems } from '../../render.js';\nimport { apply, compose, create } from '../../transform.js';\n/**\n * @classdesc\n * Canvas renderer for image layers.\n * @api\n */\nvar CanvasVectorImageLayerRenderer = /** @class */ (function (_super) {\n    __extends(CanvasVectorImageLayerRenderer, _super);\n    /**\n     * @param {import(\"../../layer/VectorImage.js\").default} layer Vector image layer.\n     */\n    function CanvasVectorImageLayerRenderer(layer) {\n        var _this = _super.call(this, layer) || this;\n        /**\n         * @private\n         * @type {import(\"./VectorLayer.js\").default}\n         */\n        _this.vectorRenderer_ = new CanvasVectorLayerRenderer(layer);\n        /**\n         * @private\n         * @type {number}\n         */\n        _this.layerImageRatio_ = layer.getImageRatio();\n        /**\n         * @private\n         * @type {import(\"../../transform.js\").Transform}\n         */\n        _this.coordinateToVectorPixelTransform_ = create();\n        /**\n         * @private\n         * @type {import(\"../../transform.js\").Transform}\n         */\n        _this.renderedPixelToCoordinateTransform_ = null;\n        return _this;\n    }\n    /**\n     * @inheritDoc\n     */\n    CanvasVectorImageLayerRenderer.prototype.disposeInternal = function () {\n        this.vectorRenderer_.dispose();\n        _super.prototype.disposeInternal.call(this);\n    };\n    /**\n     * @inheritDoc\n     */\n    CanvasVectorImageLayerRenderer.prototype.getFeatures = function (pixel) {\n        if (this.vectorRenderer_) {\n            var vectorPixel = apply(this.coordinateToVectorPixelTransform_, apply(this.renderedPixelToCoordinateTransform_, pixel.slice()));\n            return this.vectorRenderer_.getFeatures(vectorPixel);\n        }\n        else {\n            var promise = new Promise(function (resolve, reject) {\n                resolve([]);\n            });\n            return promise;\n        }\n    };\n    /**\n     * @inheritDoc\n     */\n    CanvasVectorImageLayerRenderer.prototype.handleFontsChanged = function () {\n        this.vectorRenderer_.handleFontsChanged();\n    };\n    /**\n     * @inheritDoc\n     */\n    CanvasVectorImageLayerRenderer.prototype.prepareFrame = function (frameState) {\n        var pixelRatio = frameState.pixelRatio;\n        var viewState = frameState.viewState;\n        var viewResolution = viewState.resolution;\n        var hints = frameState.viewHints;\n        var vectorRenderer = this.vectorRenderer_;\n        var renderedExtent = frameState.extent;\n        if (this.layerImageRatio_ !== 1) {\n            renderedExtent = renderedExtent.slice(0);\n            scaleFromCenter(renderedExtent, this.layerImageRatio_);\n        }\n        var width = getWidth(renderedExtent) / viewResolution;\n        var height = getHeight(renderedExtent) / viewResolution;\n        if (!hints[ViewHint.ANIMATING] && !hints[ViewHint.INTERACTING] && !isEmpty(renderedExtent)) {\n            vectorRenderer.useContainer(null, null, 1);\n            var context = vectorRenderer.context;\n            var imageFrameState_1 = /** @type {import(\"../../PluggableMap.js\").FrameState} */ (assign({}, frameState, {\n                declutterItems: [],\n                extent: renderedExtent,\n                size: [width, height],\n                viewState: /** @type {import(\"../../View.js\").State} */ (assign({}, frameState.viewState, {\n                    rotation: 0\n                }))\n            }));\n            var image_1 = new ImageCanvas(renderedExtent, viewResolution, pixelRatio, context.canvas, function (callback) {\n                if (vectorRenderer.prepareFrame(imageFrameState_1) && vectorRenderer.replayGroupChanged) {\n                    vectorRenderer.renderFrame(imageFrameState_1, null);\n                    renderDeclutterItems(imageFrameState_1, null);\n                    callback();\n                }\n            });\n            image_1.addEventListener(EventType.CHANGE, function () {\n                if (image_1.getState() === ImageState.LOADED) {\n                    this.image_ = image_1;\n                }\n            }.bind(this));\n            image_1.load();\n        }\n        if (this.image_) {\n            var image = this.image_;\n            var imageResolution = image.getResolution();\n            var imagePixelRatio = image.getPixelRatio();\n            var renderedResolution = imageResolution * pixelRatio / imagePixelRatio;\n            this.renderedResolution = renderedResolution;\n            this.renderedPixelToCoordinateTransform_ = frameState.pixelToCoordinateTransform.slice();\n            this.coordinateToVectorPixelTransform_ = compose(this.coordinateToVectorPixelTransform_, width / 2, height / 2, 1 / renderedResolution, -1 / renderedResolution, 0, -viewState.center[0], -viewState.center[1]);\n        }\n        return !!this.image_;\n    };\n    /**\n     * @override\n     */\n    CanvasVectorImageLayerRenderer.prototype.preRender = function () { };\n    /**\n     * @override\n     */\n    CanvasVectorImageLayerRenderer.prototype.postRender = function () { };\n    /**\n     * @inheritDoc\n     */\n    CanvasVectorImageLayerRenderer.prototype.forEachFeatureAtCoordinate = function (coordinate, frameState, hitTolerance, callback, declutteredFeatures) {\n        if (this.vectorRenderer_) {\n            return this.vectorRenderer_.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, declutteredFeatures);\n        }\n        else {\n            return _super.prototype.forEachFeatureAtCoordinate.call(this, coordinate, frameState, hitTolerance, callback, declutteredFeatures);\n        }\n    };\n    return CanvasVectorImageLayerRenderer;\n}(CanvasImageLayerRenderer));\nexport default CanvasVectorImageLayerRenderer;\n//# sourceMappingURL=VectorImageLayer.js.map"]},"metadata":{},"sourceType":"module"}